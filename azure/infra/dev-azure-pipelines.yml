
trigger: none
  # branches:
  #   include:
  #   - main

parameters:
  - name: RunDeploy
    displayName: "run deployment step"
    type: boolean
    default: true

stages:
- stage: dockerbuild
  displayname: DockerBuild

  jobs:
  - job: build
    displayName: Build
# #############

    pool:
      vmImage: ubuntu-latest

    variables:
      - group: docker-settings

    steps:
      # Login to DockerHub
      - script: docker login -u $(dockerId) -p $pass
        env:
          pass: $(dockerPassword)
        displayName: Login to DockerHub

      # Build and run tests
      - script: |
          docker pull $(dockerRegistry)/$(dockerImageName):cache-test-dependencies || true
          docker pull $(dockerRegistry)/$(dockerImageName):cache-test || true

          docker-compose --file=docker-compose.test.yml build
        displayName: Build test Docker image
      - script: docker-compose --file=docker-compose.test.yml run --rm test
        displayName: Run tests on Docker

      # Clean up
      - script: |
          git reset --hard
          git clean -xdf
        displayName: Clean repository

      # Publish
      - publish: $(System.DefaultWorkingDirectory)
        artifact: repository
        displayName: Publish repository as artifact

      # Build web dependencies
      - script: |
          docker pull $(dockerRegistry)/$(dockerImageName):cache-web-dependencies || true

          docker build \
            --file=Dockerfile \
            --cache-from=$(dockerRegistry)/$(dockerImageName):cache-web-dependencies \
            --tag=local/dfe-teachers-payment-service:web-dependencies \
            --target=dependencies \
            .
        displayName: Build web dependencies Docker image using 'cache-web-dependencies' as cache
        condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
      - script: |
          docker build \
            --file=Dockerfile \
            --tag=local/dfe-teachers-payment-service:web-dependencies \
            --target=dependencies \
            .
        displayName: Build web dependencies Docker image without cache
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

      # Build web
      - script: |
          docker pull $(dockerRegistry)/$(dockerImageName):latest || true

          docker build \
            --file=Dockerfile \
            --cache-from=local/dfe-teachers-payment-service:web-dependencies \
            --cache-from=$(dockerRegistry)/$(dockerImageName):latest \
            --tag=local/dfe-teachers-payment-service:web \
            --target=web \
            --build-arg GIT_COMMIT_HASH=$(Build.SourceVersion) \
            .
        displayName: Build web Docker image using 'latest' as cache
        condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
      - script: |
          docker build \
            --file=Dockerfile \
            --cache-from=local/dfe-teachers-payment-service:web-dependencies \
            --tag=local/dfe-teachers-payment-service:web \
            --target=web \
            --build-arg GIT_COMMIT_HASH=$(Build.SourceVersion) \
            .
        displayName: Build web Docker image without cache
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

      # Push test images
      - script: |
          docker tag local/dfe-teachers-payment-service:test-dependencies $(dockerRegistry)/$(dockerImageName):cache-test-dependencies

          docker push $(dockerRegistry)/$(dockerImageName):cache-test-dependencies
        displayName: Push test dependencies Docker image for caching
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
      - script: |
          docker tag local/dfe-teachers-payment-service:test $(dockerRegistry)/$(dockerImageName):cache-test

          docker push $(dockerRegistry)/$(dockerImageName):cache-test
        displayName: Push test Docker image for caching
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

      # Push web images
      - script: |
          docker tag local/dfe-teachers-payment-service:web-dependencies $(dockerRegistry)/$(dockerImageName):cache-web-dependencies

          docker push $(dockerRegistry)/$(dockerImageName):cache-web-dependencies
        displayName: Push web dependencies Docker image for caching
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
      - script: |
          docker tag local/dfe-teachers-payment-service:web $(dockerRegistry)/$(dockerImageName):$(Build.BuildNumber)
          docker tag local/dfe-teachers-payment-service:web $(dockerRegistry)/$(dockerImageName):latest

          docker push $(dockerRegistry)/$(dockerImageName):$(Build.BuildNumber)
          docker push $(dockerRegistry)/$(dockerImageName):latest
        displayName: Push web Docker image
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')

# ##############

- stage: plan
  displayName: Plan
  dependsOn: build
  condition: ${{ parameters.RunDeploy }}  

  jobs:
  - job: plan 
    displayName: Plan

    pool:
      vmImage: "ubuntu-latest"

    steps:
    - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
      displayName: 'Installing Terraform $(Terraform.Version) for plan'
      inputs:
        terraformVersion: '0.14.6'

    - task: TerraformTaskV1@0
      name: TFInit
      displayName: "TerraForm init"
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/azure/infra/terraform'
        commandOptions: '-backend-config="storage_account_name=s118d01dfbackendsa" -backend-config="container_name=s118d01devtfstate"'
        backendServiceArm: 'azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef'
        backendAzureRmResourceGroupName: 's118d01-tfbackend'
        backendAzureRmStorageAccountName: 's118d01tfbackendsa'
        backendAzureRmContainerName: 's118d01devtfstate'
        backendAzureRmKey: 'terraform.tfstate'

    - task: AzurePowerShell@5
      displayName: 'Open KeyVault Firewall'
      inputs:
        azureSubscription: "azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef"
        TargetAzurePs: LatestVersion      
        ScriptType: InlineScript
        Inline: |
          # Setting Variables
          $KeyVaultId = '/subscriptions/8655985a-2f87-44d7-a541-0be9a8c2779d/resourceGroups/s118d01-secrets/providers/Microsoft.KeyVault/vaults/s118d01-secrets-kv'
          $KeyVault = Get-AzResource -ResourceId $KeyVaultId -ErrorAction SilentlyContinue
          If ($null -eq $KeyVault) {
            Write-Output "##vso[task.logissue type=warning;]The Key Vault with Id $KeyVaultId does not exist"
            Exit 0
          }
          $KeyVault = Get-AzKeyVault -ResourceGroupName $KeyVault.ResourceGroupName -VaultName $KeyVault.Name
          Write-Output 'Updating Key Vault rules...'
          $KeyVault | Update-AzKeyVaultNetworkRuleSet -DefaultAction Allow 
          $LoopCount = 0
          Write-Output "Waiting for Access..." 
          # This will check every 5 seconds, up to a maximum of 30 seconds
          Do {
              $AccessAllowed = $KeyVault | Get-AzKeyVaultSecret -ErrorAction SilentlyContinue
              $LoopCount++
              Start-Sleep -Seconds 5
          }
          While ($null -eq $AccessAllowed -and $LoopCount -lt 6)
    - task: TerraformTaskV1@0
      displayName: "TerraForm plan"
      name: TFPlan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/azure/infra/terraform'
        commandOptions: '-var="input_region=$(REGION)" -var="input_environment=$(environment)"'
        environmentServiceNameAzureRM: 'azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef'

    - task: AzurePowerShell@5
      displayName: 'Close KeyVault Firewall'
      condition: always()
      inputs:
        azureSubscription: "azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef"
        TargetAzurePs: LatestVersion 
        ScriptType: InlineScript
        Inline: |
          # Setting Variables
          $KeyVaultId = '/subscriptions/8655985a-2f87-44d7-a541-0be9a8c2779d/resourceGroups/s118d01-secrets/providers/Microsoft.KeyVault/vaults/s118d01-secrets-kv'
          $KeyVault = Get-AzResource -ResourceId $KeyVaultId -ErrorAction SilentlyContinue
          $KeyVault = Get-AzKeyVault -ResourceGroupName $KeyVault.ResourceGroupName -VaultName $KeyVault.Name
          Write-Output 'Updating Key Vault rules...'
          $KeyVault | Update-AzKeyVaultNetworkRuleSet -DefaultAction Deny 

    - task: CopyFiles@2
      displayName: 'Stage Artifacts'
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)'
        Contents: |
          terraform/**
          .artifactignore
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        flattenFolders: false

    # Publish artifact to pipeline
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'dev_plan'
        publishLocation: 'pipeline'

- stage: apply
  displayName: Apply
  dependsOn: plan
  condition: ${{ parameters.RunDeploy }}

  jobs:
  - job: apply
    displayName: Apply

    pool:
      vmImage: 'ubuntu-latest'

#  strategy:
#    runOnce:
#      deploy:
    steps:
      - download: current
        artifact: 'dev_plan'

      - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
        displayName: 'Installing Terraform $(Terraform.Version) for apply'
        inputs:
          terraformVersion: '0.14.6'

      - task: TerraformTaskV1@0
        name: TFInit
        displayName: "TerraForm init"
        inputs:
          provider: "azurerm"
          command: "init"
          workingDirectory: "$(System.DefaultWorkingDirectory)/azure/infra/terraform"
          commandOptions: '-backend-config="storage_account_name=s118d01dfbackendsa" -backend-config="container_name=s118d01devtfstate"'
          backendServiceArm: "azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef"
          backendAzureRmResourceGroupName: "s118d01-tfbackend"
          backendAzureRmStorageAccountName: "s118d01tfbackendsa"
          backendAzureRmContainerName: "s118d01devtfstate"
          backendAzureRmKey: "terraform.tfstate"        

      - task: AzurePowerShell@5
        displayName: 'Open KeyVault Firewall'
        inputs:
          azureSubscription: "azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef"
          TargetAzurePs: LatestVersion      
          ScriptType: InlineScript
          Inline: |
            # Setting Variables
            $KeyVaultId = '/subscriptions/8655985a-2f87-44d7-a541-0be9a8c2779d/resourceGroups/s118d01-secrets/providers/Microsoft.KeyVault/vaults/s118d01-secrets-kv'
            $KeyVault = Get-AzResource -ResourceId $KeyVaultId -ErrorAction SilentlyContinue
            If ($null -eq $KeyVault) {
              Write-Output "##vso[task.logissue type=warning;]The Key Vault with Id $KeyVaultId does not exist"
              Exit 0
            }
            $KeyVault = Get-AzKeyVault -ResourceGroupName $KeyVault.ResourceGroupName -VaultName $KeyVault.Name
            Write-Output 'Updating Key Vault rules...'
            $KeyVault | Update-AzKeyVaultNetworkRuleSet -DefaultAction Allow 
            $LoopCount = 0
            Write-Output "Waiting for Access..." 
            # This will check every 5 seconds, up to a maximum of 30 seconds
            Do {
                $AccessAllowed = $KeyVault | Get-AzKeyVaultSecret -ErrorAction SilentlyContinue
                $LoopCount++
                Start-Sleep -Seconds 5
            }
            While ($null -eq $AccessAllowed -and $LoopCount -lt 6)

      - task: TerraformCLI@0
        displayName: "TerraForm apply"
        name: TFApply
        inputs:
          command: 'apply'
          runAzLogin: true  
          environmentServiceName: 'azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef'
          workingDirectory: '$(System.DefaultWorkingDirectory)/azure/infra/terraform'          
          commandOptions: '-var="input_region=$(REGION)" -var="input_environment=$(environment)"'
          allowTelemetryCollection: true

  # - task: TerraformTaskV1@0
  #   displayName: 'TF destroy example'
  #   name: TFDestroy
  #   inputs:
  #     provider: 'azurerm'
  #     command: 'destroy'
  #     workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
  #.    commandOptions: '-var="input_region=$(REGION)" -var="input_rg_prefix=$(rg_prefix)"'
  #     environmentServiceNameAzureRM: 'azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef'

      - task: AzurePowerShell@5
        displayName: 'Close KeyVault Firewall'
        condition: always()
        inputs:
          azureSubscription: "azdo.pipelines.cip.S118D.armfe1ef140-8bef-4043-b5ee-c449e6f951ef"
          TargetAzurePs: LatestVersion 
          ScriptType: InlineScript
          Inline: |
            # Setting Variables
            $KeyVaultId = '/subscriptions/8655985a-2f87-44d7-a541-0be9a8c2779d/resourceGroups/s118d01-secrets/providers/Microsoft.KeyVault/vaults/s118d01-secrets-kv'
            $KeyVault = Get-AzResource -ResourceId $KeyVaultId -ErrorAction SilentlyContinue
            $KeyVault = Get-AzKeyVault -ResourceGroupName $KeyVault.ResourceGroupName -VaultName $KeyVault.Name
            Write-Output 'Updating Key Vault rules...'
            $KeyVault | Update-AzKeyVaultNetworkRuleSet -DefaultAction Deny 